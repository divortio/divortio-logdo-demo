<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogDO by Divortio - Demo</title>
    <meta name="description" content="LogDO by Divortio - Demo">

    <link rel="icon" href="./assets/images/icons/favicon.svg" type="image/svg+xml">
    <link rel="alternate icon" href="./assets/images/icons/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/images/icons/apple-touch-icon.png">
    <link rel="manifest" href="./assets/site.webmanifest">
    <link rel="mask-icon" href="./assets/images/icons/safari-pinned-tab.svg" color="#02040a">
    <meta name="msapplication-TileColor" content="#02040a">
    <meta name="theme-color" content="#ffffff">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.divort.io/">
    <meta property="og:title" content="Divortio - A beacon through the fog of a high-conflict divorce.">
    <meta property="og:description" content="A beacon for those navigating the fog of a high-conflict divorce.">
    <meta property="og:image" content="https://www.divort.io/assets/images/banners/divortio-og-banner-1200x630.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.divort.io/">
    <meta property="twitter:title" content="Divortio - A beacon through the fog of a high-conflict divorce.">
    <meta property="twitter:description" content="A beacon for those navigating the fog of a high-conflict divorce.">
    <meta property="twitter:image"
          content="https://www.divort.io/assets/images/banners/divortio-og-banner-1200x630.png">

    <script src="./vendor/js/tailwindcss.js"></script>
    <style>
        @import url("./vendor/fonts/google-fonts.css");

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: #02040a;
            color: #e6edf3;
            font-family: 'Inter', sans-serif;
        }

        .logo-font {
            font-family: 'Playfair Display', serif;
        }

        .content-wrapper {
            position: relative;
            z-index: 1;
        }

        .data-card {
            background-color: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-key {
            color: #9ca3af;
            font-weight: 500;
            white-space: nowrap;
        }

        .data-value, .data-table {
            color: #e5e7eb;
            word-break: break-all;
        }

        .data-table th, .data-table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
        }

        .data-table th {
            font-weight: 600;
            text-align: left;
        }

        .group-title {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            font-style: italic;
            color: #60a5fa;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            margin-top: 2.5rem;
        }

        .group-title:first-of-type {
            margin-top: 0;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
<div class="content-wrapper container mx-auto max-w-7xl">
    <header class="mb-12 text-center py-24">
        <h1 class="relative z-10 logo-font text-5xl md:text-6xl text-white">LogDO</h1>
        <p class="relative z-10 text-lg md:text-xl mt-4 text-gray-400 italic" id="hero-logo">
            by
            <span>D</span><span>i</span><span>v</span><span>o</span><span>r</span><span>t</span><span>i</span><span>o</span>
        </p>
    </header>

    <main class="data-card rounded-xl p-6 sm:p-8">
        <div id="log-container">
        </div>
    </main>

    <footer class="text-center py-8 mt-8">
        <p class="text-gray-500">&copy; 2025 Divortio. All rights reserved.</p>
    </footer>
</div>

<script id="log-data-script"></script>

<script>
    // --- Data for offline debugging ---
    const dummyLogData = {
        "logid": "0QZ7qAbkL9xZ~_bVn2m",
        "rayid": "8c7b6a5f4d3e2c1a-EWR",
        "fpid": "aBcDeFgHiJkLmNoP",
        "devicehash": "1234567890abcdef",
        "connectionhash": "fedcba0987654321",
        "tlshash": "abcdef1234567890",
        "requesttime": 1724538000123,
        "receivedat": "2025-08-24T23:40:00.125Z",
        "processedat": "2025-08-24T23:40:00.128Z",
        "processingdurationms": 3,
        "clienttcprtt": 50,
        "sample10": 7,
        "sample100": 73,
        "requesturl": "https://inspector.example.com/?debug=true",
        "requestmethod": "GET",
        "requestheaders": "{\"accept\":\"*/*\",\"user-agent\":\"Mozilla/5.0...\",\"debug\":\"true\"}",
        "requestbody": "{\"key\":\"value\"}",
        "requestmimetype": "application/json",
        "urldomain": "inspector.example.com",
        "urlpath": "/",
        "urlquery": "?debug=true",
        "headerbytes": 256,
        "bodybytes": 15,
        "bodytruncated": false,
        "clientip": "198.51.100.1",
        "clientdevicetype": "desktop",
        "clientcookies": "{\"_ss_cID\":\"0QYabcde1234567890\",\"_ss_sID\":\"0QZ12345abcdefghij\",\"_ss_eID\":\"0QZ7qAbkL9xZ~_bVn2m\"}",
        "cId": "0QYabcde1234567890",
        "sId": "0QZ12345abcdefghij",
        "eId": "0QZ7qAbkL9xZ~_bVn2m",
        "uID": "0QZ7qAbkL9xZdefghij",
        "emA": "john@example.com",
        "cfasn": 13335,
        "cfasorganization": "Cloudflare, Inc.",
        "cfbotmanagement": "{\"score\":5,\"verifiedBot\":false}",
        "cfclientacceptencoding": "gzip, deflate, br",
        "cfcolo": "EWR",
        "cfcountry": "US",
        "cfcity": "Newark",
        "cfcontinent": "NA",
        "cfhttpprotocol": "HTTP/2",
        "cflatitude": "40.73570",
        "cflongitude": "-74.17240",
        "cfpostalcode": "07114",
        "cfregion": "New Jersey",
        "cfregioncode": "NJ",
        "cftimezone": "America/New_York",
        "cftlscipher": "AEAD-AES128-GCM-SHA256",
        "cftlsversion": "TLSv1.3",
        "cftlsclientauth": "{\"certIssuerDNLegacy\":\"\",\"certIssuerDN\":\"\",\"certPresented\":\"0\",\"certSubjectDNLegacy\":\"\",\"certSubjectDN\":\"\",\"certVerified\":\"NONE\"}",
        "geoid": "NA-US-NJ-Newark-07114",
        "threatscore": 5,
        "ja3hash": "e7d705a3286e19ea42f587f344ee6865",
        "verifiedbot": false,
        "workerenv": "{}",
        "data": "{}"
    };

    const DATA_MAP = {
        "Log & Event": {
            logid: "Log ID",
            rayid: "Ray ID",
            eId: "Event ID",
            eventTime: "Event Time",
            receivedat: "Received At",
            processedat: "Processed At",
            processingdurationms: "Processing Time (ms)"
        },
        "Client Identity": {
            uID: "User ID",
            emA: "Email Address",
            eID: "Email ID",
            cId: "Client ID",
            firstVisited: "First Visited",
            clientAge: "Client Age",
            sId: "Session ID",
            sessionStarted: "Session Started",
            sessionDuration: "Session Duration"
        },
        "Fingerprint": {
            fpid: "Browser ID",
            devicehash: "Device ID",
            connectionhash: "Connection ID",
            tlshash: "TLS ID",
            ja3hash: "JA3 ID",
            clientdevicetype: "Device Type"
        },
        "Request": {
            requesttime: "Request Time",
            requestmethod: "Method",
            requesturl: "Full URL",
            urldomain: "Domain",
            urlpath: "Path",
            urlquery: "Parameters",
            requestmimetype: "MIME Type",
            headerbytes: "Header Bytes",
            bodybytes: "Body Bytes",
            bodytruncated: "Body Truncated",
            sample10: "Decile",
            sample100: "Percentile"
        },
        "Connection": {
            cfcolo: "Cloudflare Colo",
            clientip: "IP Address",
            clienttcprtt: "Ping (ms)",
            cfasn: "ASN",
            cfasorganization: "AS Organization",
            cfhttpprotocol: "HTTP Protocol"
        },
        "GeoIP": {
            geoid: "Geo ID",
            cfcontinent: "Continent",
            cfcountry: "Country",
            cfregion: "Region",
            cfcity: "City",
            cfpostalcode: "Postal Code",
            cftimezone: "Timezone",
            coordinates: "Coordinates"
        },
        "Security": {
            cftlsversion: "TLS Version",
            cftlscipher: "TLS Cipher",
            threatscore: "Threat Score",
            verifiedbot: "Verified Bot",
            cfbotmanagement: "Bot Management",
            cftlsclientauth: "TLS Client Auth"
        },
        "Headers": {
            requestheaders: "Headers"
        },
        "Cookies": {
            clientcookies: "Cookies"
        },
        "Request Body": {
            requestbody: "Body"
        }
    };

    // --- PUSHID DECODER LIBRARY ---
    const pushIDDecoder = (function () {
        const PUSH_CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz~';
        const CHARS_MAP = {};
        for (let i = 0; i < PUSH_CHARS.length; i++) CHARS_MAP[PUSH_CHARS[i]] = i;

        function decodeTime(id) {
            if (typeof id !== 'string' || id.length < 8) return null;
            const timeStr = id.substring(0, 8);
            let timestamp = 0;
            for (let i = 0; i < timeStr.length; i++) {
                const charValue = CHARS_MAP[timeStr[i]];
                if (charValue === undefined) return null;
                timestamp = timestamp * 64 + charValue;
            }
            return timestamp;
        }

        return {decodeTime};
    })();

    // --- DATA MAPPING & RENDERING LOGIC ---
    // This script now runs on the client-side, using the data injected by the Worker.

    function formatDuration(ms) {
        if (ms < 0) ms = 0;
        const totalSeconds = Math.floor(ms / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = String(Math.floor((totalSeconds % 86400) / 3600)).padStart(2, '0');
        const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        if (days > 0) return `${days}d ${hours}h ${minutes}m ${seconds}s`;
        return `${hours}:${minutes}:${seconds}`;
    }

    function renderLogData(logDataToRender) {
        const container = document.getElementById('log-container');
        if (!container) return;

        const clientTimestamp = pushIDDecoder.decodeTime(logDataToRender.cId);
        const sessionTimestamp = pushIDDecoder.decodeTime(logDataToRender.sId);
        const eventTimestamp = pushIDDecoder.decodeTime(logDataToRender.eId);

        const enrichedData = {...logDataToRender};

        if (clientTimestamp) {
            enrichedData.firstVisited = new Date(clientTimestamp).toISOString();
            enrichedData.clientAge = formatDuration(Date.now() - clientTimestamp);
        }
        if (sessionTimestamp) {
            enrichedData.sessionStarted = new Date(sessionTimestamp).toISOString();
            if (eventTimestamp) {
                enrichedData.sessionDuration = formatDuration(eventTimestamp - sessionTimestamp);
            }
        }
        if (eventTimestamp) {
            enrichedData.eventTime = new Date(eventTimestamp).toISOString();
        }
        enrichedData.coordinates = `${logDataToRender.cflatitude || 'N/A'}, ${logDataToRender.cflongitude || 'N/A'}`;

        let html = '<div class="grid grid-cols-1 lg:grid-cols-3 gap-x-12">';

        const columns = [
            ["Log & Event", "Client Identity", "Fingerprint"],
            ["Request", "Connection", "GeoIP", "Security"],
            ["Headers", "Cookies", "Request Body"]
        ];

        for (const column of columns) {
            html += '<div>';
            for (const groupName of column) {
                html += renderGroup(groupName, DATA_MAP[groupName], enrichedData);
            }
            html += '</div>';
        }

        html += '</div>';
        container.innerHTML = html;
    }

    function renderGroup(groupName, groupContent, data) {
        let groupHtml = `<h2 class="group-title text-2xl">${groupName}</h2>`;
        groupHtml += '<div>';
        groupHtml += renderFields(groupContent, data);
        groupHtml += '</div>';
        return groupHtml;
    }

    function renderFields(fields, data) {
        let fieldsHtml = '';
        const isTableOnly = fields.hasOwnProperty('requestheaders') || fields.hasOwnProperty('clientcookies');

        if (!isTableOnly) {
            fieldsHtml += '<table class="data-table w-full text-sm"><tbody>';
        }

        for (const key in fields) {
            const displayName = fields[key];
            let value = data[key];

            if (value === undefined || value === null || value === '') continue;

            let valueHtml = '';
            if (key === 'requesttime') {
                value = new Date(value).toISOString();
            }

            if (key === 'requestbody' && value) {
                valueHtml = `<pre class="data-value bg-black bg-opacity-20 p-2 rounded-md mt-1 text-xs">${value}</pre>`;
            } else if (key === 'requestheaders' || key === 'clientcookies') {
                try {
                    const parsed = JSON.parse(value);
                    valueHtml = '<table class="data-table w-full text-xs"><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>';
                    for (const k in parsed) {
                        valueHtml += `<tr><td>${k}</td><td>${parsed[k]}</td></tr>`;
                    }
                    valueHtml += '</tbody></table>';
                } catch (e) {
                    valueHtml = `<div class="data-value">${value}</div>`;
                }
            } else {
                valueHtml = `<div class="data-value">${value}</div>`;
            }

            if (isTableOnly) {
                fieldsHtml += valueHtml;
            } else {
                fieldsHtml += `<tr><td class="data-key w-1/3">${displayName}</td><td class="data-value">${valueHtml}</td></tr>`;
            }
        }

        if (!isTableOnly) {
            fieldsHtml += '</tbody></table>';
        }

        return fieldsHtml;
    }


    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('debug') === 'true') {
            // dummyLogData and DATA_MAP are defined in the script tag above
            renderLogData(dummyLogData);
        } else {
            // logData is injected by the worker via the log-data-script tag
            renderLogData(window.logData || {});
        }
    });
</script>

</body>
</html>